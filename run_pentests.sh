#!/bin/bash

# ATM Penetration Test Runner Script
# Automates the setup and execution of penetration tests

set -e  # Exit on error

echo "╔══════════════════════════════════════════════════════════════╗"
echo "║           ATM PENETRATION TEST AUTOMATION                    ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if binaries exist
echo "[*] Checking prerequisites..."

if [ ! -f "./bin/atm" ] || [ ! -f "./bin/bank" ] || [ ! -f "./bin/router" ] || [ ! -f "./bin/init" ]; then
    echo -e "${RED}[-] Binaries not found. Building project...${NC}"
    make clean
    make
    echo -e "${GREEN}[+] Build complete${NC}"
else
    echo -e "${GREEN}[+] Binaries found${NC}"
fi

# Check if bank.atm exists
if [ ! -f "bank.atm" ]; then
    echo -e "${YELLOW}[!] bank.atm not found. Creating initialization...${NC}"
    ./bin/init bank.atm alice 1234 100
    echo -e "${GREEN}[+] Initialization complete${NC}"
else
    echo -e "${GREEN}[+] bank.atm exists${NC}"
fi

# Check if alice.card exists
if [ ! -f "alice.card" ]; then
    echo -e "${YELLOW}[!] alice.card not found. User will be created by test script${NC}"
else
    echo -e "${GREEN}[+] alice.card exists${NC}"
fi

# Check if router is running
if ! pgrep -f "./bin/router" > /dev/null; then
    echo -e "${YELLOW}[!] Router not running. Starting router in background...${NC}"
    ./bin/router 3000 3001 > router.log 2>&1 &
    ROUTER_PID=$!
    echo $ROUTER_PID > .router.pid
    sleep 1
    echo -e "${GREEN}[+] Router started (PID: $ROUTER_PID)${NC}"
else
    echo -e "${GREEN}[+] Router already running${NC}"
    ROUTER_PID=$(pgrep -f "./bin/router")
fi

# Check if bank is running
if ! pgrep -f "./bin/bank" > /dev/null; then
    echo -e "${YELLOW}[!] Bank not running. Starting bank in background...${NC}"
    ./bin/bank bank.atm > bank.log 2>&1 &
    BANK_PID=$!
    echo $BANK_PID > .bank.pid
    sleep 2
    echo -e "${GREEN}[+] Bank started (PID: $BANK_PID)${NC}"
else
    echo -e "${GREEN}[+] Bank already running${NC}"
    BANK_PID=$(pgrep -f "./bin/bank")
fi

echo ""
echo "[*] All prerequisites met. Starting penetration tests..."
echo ""

# Run the penetration tests
python3 atm_pentest.py

TEST_RESULT=$?

echo ""
echo "[*] Penetration tests complete."

# Cleanup function
cleanup() {
    echo ""
    echo "[*] Cleaning up..."
    
    if [ -f ".router.pid" ]; then
        ROUTER_PID=$(cat .router.pid)
        if kill -0 $ROUTER_PID 2>/dev/null; then
            echo "[*] Stopping router (PID: $ROUTER_PID)..."
            kill $ROUTER_PID
            rm .router.pid
        fi
    fi
    
    if [ -f ".bank.pid" ]; then
        BANK_PID=$(cat .bank.pid)
        if kill -0 $BANK_PID 2>/dev/null; then
            echo "[*] Stopping bank (PID: $BANK_PID)..."
            kill $BANK_PID
            rm .bank.pid
        fi
    fi
    
    echo "[*] Cleanup complete."
}

# Ask if user wants to stop services
echo ""
read -p "Stop bank and router services? [y/N] " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    cleanup
else
    echo "[*] Leaving services running for manual testing."
    echo "[*] Router PID: $ROUTER_PID (log: router.log)"
    echo "[*] Bank PID: $BANK_PID (log: bank.log)"
    echo "[*] To stop manually: kill $ROUTER_PID $BANK_PID"
fi

exit $TEST_RESULT
