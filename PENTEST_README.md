# ATM Penetration Testing Guide

## Overview

This document describes the comprehensive penetration testing suite for the ATM system. The test suite (`atm_pentest.py`) contains rigorous security tests designed to identify vulnerabilities in authentication, session management, transaction handling, and protocol security.

## Test Categories

### 1. Authentication Attacks
- **SQL Injection**: Tests resistance to SQL injection in username field
- **Command Injection**: Attempts to execute arbitrary commands via username input
- **Path Traversal**: Tests for directory traversal vulnerabilities
- **Buffer Overflow**: Tests username field with various oversized inputs (250-8192 bytes)
- **Format String**: Tests for format string vulnerabilities
- **Null Byte Injection**: Tests null byte handling in username
- **PIN Brute Force**: Attempts multiple incorrect PINs to test rate limiting
- **Timing Attacks**: Measures PIN verification timing to detect information leakage

### 2. Session Management Attacks
- **Concurrent Session Prevention**: Verifies only one user can be logged in
- **Session Hijacking**: Attempts to switch users mid-session
- **Session Fixation**: Tests if session IDs can be predicted or reused

### 3. Transaction Attacks
- **Negative Withdrawal**: Attempts to withdraw negative amounts (credit injection)
- **Integer Overflow**: Tests with values exceeding INT_MAX, UINT_MAX, ULLONG_MAX
- **Race Condition**: Rapid withdrawal attempts to test synchronization
- **Unauthenticated Transactions**: Attempts withdrawal/balance without login

### 4. Input Validation Attacks
- **Malformed Commands**: Empty, whitespace-only, incomplete commands
- **Special Characters**: Shell metacharacters in amount field
- **Type Confusion**: Non-numeric values where numbers expected

### 5. Cryptographic Attacks
- **Card File Tampering**: Modifies card file bits to test integrity checks
- **Replay Attacks**: Manual test guidance for network packet replay
- **Message Integrity**: Manual test for MITM packet modification

### 6. Denial of Service Attacks
- **Resource Exhaustion**: 1000 rapid authentication attempts
- **Long Input DoS**: 1MB+ input strings
- **Timeout Testing**: Ensures system doesn't hang on malicious input

### 7. Privilege Escalation
- **Unauthorized Operations**: Commands without authentication
- **Cross-User Access**: Attempting to use wrong PIN for different users

### 8. File System Security
- **Permission Checks**: Verifies proper file permissions on .atm and .card files
- **World-Readable Detection**: Warns if sensitive files are globally accessible

### 9. Protocol Attacks
- **MITM Detection**: Guidance for manual network interception tests
- **Message Tampering**: Manual test instructions for packet modification

### 10. Edge Cases
- **Unicode Input**: Cyrillic, Chinese, Arabic, Hebrew, Emoji characters
- **Whitespace Handling**: Leading/trailing/embedded whitespace
- **Case Sensitivity**: Command and username case variations
- **Partial Commands**: Incomplete command strings

## Prerequisites

### Required Setup

1. **Build the project**:
   ```bash
   make
   ```

2. **Start the router** (in separate terminal):
   ```bash
   ./bin/router 3000 3001
   ```

3. **Start the bank** (in separate terminal):
   ```bash
   ./bin/bank bank.atm
   ```

4. **Create test user** (if not already exists):
   ```bash
   ./bin/init bank.atm alice 1234 100
   ```

5. **Verify alice.card exists** in current directory

## Running the Tests

### Quick Start
```bash
python3 atm_pentest.py
```

### Prerequisites Check
The script will automatically:
- Check if `./bin/atm` exists
- Check if `bank.atm` exists
- Check if `alice.card` exists (creates user if missing)
- Exit with error if prerequisites not met

### Expected Output

```
╔══════════════════════════════════════════════════════════════╗
║           ATM PENETRATION TESTING SUITE                      ║
║           Security Assessment Tool                            ║
╚══════════════════════════════════════════════════════════════╝

[*] ============================================================
[*] ATM PENETRATION TEST SUITE
[*] ============================================================
[*] Starting penetration tests...

[*] === AUTHENTICATION ATTACKS ===
[#] Testing: SQL Injection: alice' OR '1'='1
[+] PASS: SQL Injection: alice' OR '1'='1
...

[*] ============================================================
[*] TEST SUMMARY
[*] ============================================================
[*] Passed: 85
[*] Failed: 3
[*] Total:  88
[*] Success Rate: 96.6%
[*] ============================================================
```

### Output Legend
- `[*]` - Informational message
- `[+]` - Test passed (vulnerability properly mitigated)
- `[-]` - Test failed (potential vulnerability found)
- `[!]` - Warning (manual verification recommended)
- `[#]` - Attack attempt in progress

## Interpreting Results

### Passing Tests
A test **passes** when the ATM correctly:
- Rejects malicious input
- Returns appropriate error messages
- Maintains security boundaries
- Prevents unauthorized access

### Failing Tests
A test **fails** when:
- Malicious input is accepted
- Unauthorized access is granted
- System crashes or hangs
- Sensitive information is leaked

### Manual Tests
Some tests require manual verification:
- **Replay Attacks**: Use network sniffer (Wireshark/tcpdump) to capture and replay packets
- **MITM Attacks**: Use router to inject/modify packets
- **Timing Attacks**: Review timing data for patterns

## Advanced Testing

### Running Individual Test Categories

Edit `atm_pentest.py` and comment out unwanted test categories in the `run_all_tests()` method:

```python
def run_all_tests(self):
    # Comment out tests you don't want to run
    # self.test_sql_injection_username()
    self.test_buffer_overflow_username()
    # ...
```

### Custom Test Cases

Add your own tests following this pattern:

```python
def test_my_custom_attack(self):
    """Description of attack"""
    self.test_case(
        "My Custom Attack Name",
        ["command1", "command2"],  # Commands to send to ATM
        expected_patterns=["Expected output"],  # Should appear
        unexpected_patterns=["Should not appear"]  # Must not appear
    )
```

### Modifying Test Parameters

Key variables you can adjust:

```python
# Buffer overflow test sizes
lengths = [250, 251, 255, 256, 512, 1024, 4096, 8192]

# Brute force attempt count
for i in range(20):  # Change to test more/fewer attempts

# Resource exhaustion
for i in range(1000):  # Increase for stress testing

# Timeout values
stdout, stderr, _ = self.run_atm_command(commands, timeout=5)
```

## Security Checklist

Use this checklist to verify your implementation:

### Authentication
- [ ] Usernames validated (alphanumeric only, max 250 chars)
- [ ] PINs validated (exactly 4 digits)
- [ ] No SQL injection possible
- [ ] No command injection possible
- [ ] No path traversal possible
- [ ] Buffer overflows prevented
- [ ] Format string vulnerabilities eliminated
- [ ] Timing attacks mitigated (constant-time comparison)
- [ ] Brute force protection implemented

### Session Management
- [ ] Only one session allowed at a time
- [ ] Session hijacking prevented
- [ ] Session IDs cryptographically random
- [ ] Session timeout implemented
- [ ] Proper session cleanup on logout

### Transaction Security
- [ ] Negative amounts rejected
- [ ] Integer overflow handled
- [ ] Race conditions prevented
- [ ] Authentication required for all operations
- [ ] Balance consistency maintained

### Input Validation
- [ ] All inputs properly sanitized
- [ ] Type checking enforced
- [ ] Range checking implemented
- [ ] Special characters handled safely
- [ ] Unicode handled correctly

### Cryptography
- [ ] Card file integrity verified (HMAC/signature)
- [ ] Replay attacks prevented (nonces/timestamps)
- [ ] Message authentication implemented (MAC)
- [ ] Encryption used for sensitive data
- [ ] Secure random number generation

### File System
- [ ] .atm file: mode 600 (owner read/write only)
- [ ] .card files: mode 600 or 400 (owner only)
- [ ] No hardcoded secrets in code
- [ ] Sensitive data wiped from memory

### Network Protocol
- [ ] Messages authenticated (HMAC)
- [ ] Messages encrypted (AES)
- [ ] Replay protection (sequence numbers)
- [ ] MITM detection (mutual authentication)
- [ ] Message integrity verified

## Common Vulnerabilities Found

### Critical Issues
1. **Unauthenticated Access**: Operations allowed without login
2. **Card File Not Verified**: Tampered cards accepted
3. **Integer Overflow**: Large withdrawals bypass limits
4. **Command Injection**: Shell commands executed via input

### High Severity
1. **Buffer Overflow**: Crashes or arbitrary code execution
2. **Path Traversal**: Access to unauthorized files
3. **Session Fixation**: Predictable session IDs
4. **No Replay Protection**: Same message accepted twice

### Medium Severity
1. **Timing Attacks**: PIN verification time varies
2. **No Rate Limiting**: Brute force possible
3. **Poor Error Messages**: Information leakage
4. **Insecure Permissions**: Files world-readable

### Low Severity
1. **Missing Input Validation**: Accepts invalid format
2. **Case Sensitivity Issues**: ALICE vs alice confusion
3. **Whitespace Handling**: Leading/trailing spaces issues

## Remediation Guidelines

### For Failed Tests

1. **Review the specific test that failed**
2. **Examine the attack pattern used**
3. **Identify the vulnerable code section**
4. **Implement proper validation/sanitization**
5. **Re-run the specific test to verify fix**
6. **Run full test suite to ensure no regressions**

### Example Fix Patterns

#### Buffer Overflow Prevention
```c
// Before (vulnerable)
char username[250];
strcpy(username, user_input);

// After (secure)
char username[251];  // +1 for null terminator
strncpy(username, user_input, 250);
username[250] = '\0';
```

#### Input Validation
```c
// Validate username is alphanumeric
for (int i = 0; username[i]; i++) {
    if (!isalpha(username[i])) {
        printf("Usage: begin-session <user-name>\n");
        return;
    }
}
```

#### Constant-Time Comparison
```c
// Prevent timing attacks
int secure_compare(const char *a, const char *b, size_t len) {
    volatile unsigned char diff = 0;
    for (size_t i = 0; i < len; i++) {
        diff |= a[i] ^ b[i];
    }
    return diff == 0;
}
```

## Network Testing with Router

The router can be modified to perform MITM attacks:

### Packet Interception
```bash
# Capture packets
tcpdump -i lo -w atm_traffic.pcap port 3000 or port 3001

# Replay captured packets
tcpreplay -i lo atm_traffic.pcap
```

### Packet Modification
Modify router code to:
- Drop random packets
- Reorder packets
- Modify packet contents
- Replay old packets
- Inject new packets

## Automated vs Manual Testing

### Automated (via atm_pentest.py)
- Input validation
- Authentication bypass attempts
- Buffer overflows
- Integer overflows
- Session management
- DoS attacks
- File permission checks

### Manual Testing Required
- Network packet replay attacks
- MITM packet modification
- Side-channel attacks (power, EM)
- Physical security (card cloning)
- Social engineering
- Concurrent ATM instances
- Router compromise scenarios

## Reporting Security Issues

When you find a vulnerability:

1. **Document the attack vector**
2. **Note the affected code location**
3. **Assess the severity** (Critical/High/Medium/Low)
4. **Propose a fix**
5. **Verify the fix resolves the issue**
6. **Check for similar issues elsewhere**

## Performance Considerations

The test suite may take 2-5 minutes to complete depending on:
- Number of tests enabled
- Timeout values configured
- System performance
- Network latency

For faster iteration during development:
- Comment out passed tests
- Reduce brute force attempt counts
- Decrease timeout values
- Run specific test categories only

## Continuous Testing

Integrate into development workflow:

```bash
# Before committing code
make clean && make
python3 atm_pentest.py

# If tests pass
git add .
git commit -m "Security improvements"

# If tests fail
# Fix issues and retry
```

## Additional Resources

- **OWASP Testing Guide**: https://owasp.org/www-project-web-security-testing-guide/
- **CVE Database**: https://cve.mitre.org/
- **CWE Common Weaknesses**: https://cwe.mitre.org/
- **NIST Cybersecurity Framework**: https://www.nist.gov/cyberframework

## Support and Questions

For issues with the test suite:
1. Verify all prerequisites are met
2. Check that bank and router are running
3. Ensure test user (alice) exists
4. Review error messages carefully
5. Check file permissions on .atm and .card files

## License

This penetration testing suite is provided for educational purposes as part of CMSC414 coursework.
